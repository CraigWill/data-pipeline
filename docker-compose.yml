# Docker Compose配置文件
# 需求: 8.7 - 提供Docker Compose配置文件
# 需求: 4.5 - 容器崩溃时2分钟内自动重启
# 需求: 8.8 - 容器健康检查配置
#
# 使用方法:
#   1. 复制 .env.example 到 .env 并配置环境变量
#   2. 启动所有服务: docker-compose up -d
#   3. 查看服务状态: docker-compose ps
#   4. 查看日志: docker-compose logs -f
#   5. 停止服务: docker-compose down
#
# 扩展TaskManager:
#   docker-compose up -d --scale taskmanager=3
#
# 启用高可用模式:
#   docker-compose --profile ha up -d

services:
  # Zookeeper服务（Flink HA 依赖）
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    hostname: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
      ZOOKEEPER_SYNC_LIMIT: 2
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    networks:
      - flink-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  # Flink JobManager服务（主节点）
  jobmanager:
    build:
      context: .
      dockerfile: docker/jobmanager/Dockerfile
    container_name: flink-jobmanager
    hostname: jobmanager
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "8081:8081"  # Web UI
      - "6123:6123"  # RPC
      - "6124:6124"  # Blob Server
      - "9249:9249"  # Prometheus Metrics
    environment:
      # JobManager配置
      - JOB_MANAGER_RPC_ADDRESS=jobmanager
      - JOB_MANAGER_RPC_PORT=6123
      - JOB_MANAGER_HEAP_SIZE=1024m
      - REST_PORT=8081
      - PARALLELISM_DEFAULT=4
      
      # Checkpoint配置
      - CHECKPOINT_INTERVAL=300000
      - CHECKPOINT_DIR=file:///opt/flink/checkpoints
      - SAVEPOINT_DIR=file:///opt/flink/savepoints
      - STATE_BACKEND=hashmap
      
      # 高可用配置（启用）
      - HA_MODE=${HA_MODE:-zookeeper}
      - HA_ZOOKEEPER_QUORUM=${HA_ZOOKEEPER_QUORUM:-zookeeper:2181}
      - HA_ZOOKEEPER_PATH_ROOT=${HA_ZOOKEEPER_PATH_ROOT:-/flink}
      - HA_CLUSTER_ID=${HA_CLUSTER_ID:-/realtime-pipeline}
      - HA_STORAGE_DIR=${HA_STORAGE_DIR:-file:///opt/flink/ha}
      
      # 数据库配置（JdbcCDCApp需要）
      - DATABASE_HOST=${DATABASE_HOST:-localhost}
      - DATABASE_PORT=${DATABASE_PORT:-1521}
      - DATABASE_USERNAME=${DATABASE_USERNAME:-system}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD:-password}
      - DATABASE_SID=${DATABASE_SID:-helowin}
      - DATABASE_SCHEMA=${DATABASE_SCHEMA:-finance_user}
      - DATABASE_TABLES=${DATABASE_TABLES:-trans_info}
      - OUTPUT_PATH=${OUTPUT_PATH:-./output/cdc}
      - POLL_INTERVAL_SECONDS=${POLL_INTERVAL_SECONDS:-10}
      - TZ=Asia/Shanghai
      
      # 自动作业提交配置
      - AUTO_SUBMIT_JOB=${AUTO_SUBMIT_JOB:-true}
      - AUTO_SUBMIT_DELAY=${AUTO_SUBMIT_DELAY:-60}
      - JOB_JAR_PATH=${JOB_JAR_PATH:-/opt/flink/usrlib/realtime-data-pipeline.jar}
      - JOB_MAIN_CLASS=${JOB_MAIN_CLASS:-com.realtime.pipeline.FlinkCDC3App}
    volumes:
      - flink-checkpoints:/opt/flink/checkpoints
      - flink-savepoints:/opt/flink/savepoints
      - flink-ha:/opt/flink/ha
      - flink-logs:/opt/flink/logs
    networks:
      - flink-network
    # 需求 4.5: 容器自动重启策略
    # unless-stopped: 除非手动停止，否则总是重启
    # 容器崩溃后会立即重启，满足2分钟内重启的要求
    restart: unless-stopped
    # 健康检查配置（需求 8.8）
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/overview"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # Flink JobManager Standby（备用节点）
  jobmanager-standby:
    build:
      context: .
      dockerfile: docker/jobmanager/Dockerfile
    container_name: flink-jobmanager-standby
    hostname: jobmanager-standby
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "8082:8081"  # Web UI (使用不同端口)
      - "6125:6123"  # RPC (使用不同端口)
      - "6126:6124"  # Blob Server
      - "9250:9249"  # Prometheus Metrics
    environment:
      # JobManager配置
      - JOB_MANAGER_RPC_ADDRESS=jobmanager-standby
      - JOB_MANAGER_RPC_PORT=6123
      - JOB_MANAGER_HEAP_SIZE=1024m
      - REST_PORT=8081
      - PARALLELISM_DEFAULT=4
      
      # Checkpoint配置
      - CHECKPOINT_INTERVAL=300000
      - CHECKPOINT_DIR=file:///opt/flink/checkpoints
      - SAVEPOINT_DIR=file:///opt/flink/savepoints
      - STATE_BACKEND=hashmap
      
      # 高可用配置（与主 JobManager 相同）
      - HA_MODE=${HA_MODE:-zookeeper}
      - HA_ZOOKEEPER_QUORUM=${HA_ZOOKEEPER_QUORUM:-zookeeper:2181}
      - HA_ZOOKEEPER_PATH_ROOT=${HA_ZOOKEEPER_PATH_ROOT:-/flink}
      - HA_CLUSTER_ID=${HA_CLUSTER_ID:-/realtime-pipeline}
      - HA_STORAGE_DIR=${HA_STORAGE_DIR:-file:///opt/flink/ha}
      
      # 数据库配置
      - DATABASE_HOST=${DATABASE_HOST:-localhost}
      - DATABASE_PORT=${DATABASE_PORT:-1521}
      - DATABASE_USERNAME=${DATABASE_USERNAME:-system}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD:-password}
      - DATABASE_SID=${DATABASE_SID:-helowin}
      - DATABASE_SCHEMA=${DATABASE_SCHEMA:-finance_user}
      - DATABASE_TABLES=${DATABASE_TABLES:-trans_info}
      - OUTPUT_PATH=${OUTPUT_PATH:-./output/cdc}
      - TZ=Asia/Shanghai
    volumes:
      - flink-checkpoints:/opt/flink/checkpoints
      - flink-savepoints:/opt/flink/savepoints
      - flink-ha:/opt/flink/ha
      - flink-logs:/opt/flink/logs
    networks:
      - flink-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/overview"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # Flink TaskManager服务
  # 支持动态扩展: docker-compose up -d --scale taskmanager=3
  taskmanager:
    build:
      context: .
      dockerfile: docker/taskmanager/Dockerfile
    # 注意: 使用scale时不要设置container_name
    # container_name: flink-taskmanager-1
    depends_on:
      jobmanager:
        condition: service_healthy
    ports:
      - "6121-6130:6121"  # Data Port (支持多个TaskManager)
      - "6122"            # RPC Port (动态分配)
      - "9249"            # Prometheus Metrics (动态分配)
    environment:
      # JobManager连接配置
      - JOB_MANAGER_RPC_ADDRESS=jobmanager
      - JOB_MANAGER_RPC_PORT=6123
      
      # TaskManager配置
      - TASK_MANAGER_HEAP_SIZE=1024m
      - TASK_MANAGER_MEMORY_PROCESS_SIZE=1728m
      - TASK_MANAGER_MEMORY_MANAGED_SIZE=512m
      - TASK_MANAGER_NUMBER_OF_TASK_SLOTS=4
      - TASK_MANAGER_RPC_PORT=6122
      - TASK_MANAGER_DATA_PORT=6121
      - TASK_MANAGER_NETWORK_MEMORY_MIN=64m
      - TASK_MANAGER_NETWORK_MEMORY_MAX=256m
      
      # 高可用配置（与 JobManager 保持一致）
      - HA_MODE=${HA_MODE:-zookeeper}
      - HA_ZOOKEEPER_QUORUM=${HA_ZOOKEEPER_QUORUM:-zookeeper:2181}
      - HA_ZOOKEEPER_PATH_ROOT=${HA_ZOOKEEPER_PATH_ROOT:-/flink}
      - HA_CLUSTER_ID=${HA_CLUSTER_ID:-/realtime-pipeline}
      
      # 数据库配置（JdbcCDCApp需要）
      - DATABASE_HOST=${DATABASE_HOST:-localhost}
      - DATABASE_PORT=${DATABASE_PORT:-1521}
      - DATABASE_USERNAME=${DATABASE_USERNAME:-finance_user}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD:-password}
      - DATABASE_SID=${DATABASE_SID:-helowin}
      - DATABASE_SCHEMA=${DATABASE_SCHEMA:-finance_user}
      - DATABASE_TABLES=${DATABASE_TABLES:-trans_info}
      - OUTPUT_PATH=${OUTPUT_PATH:-./output/cdc}
      - POLL_INTERVAL_SECONDS=${POLL_INTERVAL_SECONDS:-10}
      - TZ=Asia/Shanghai
    volumes:
      - flink-checkpoints:/opt/flink/checkpoints
      - flink-savepoints:/opt/flink/savepoints
      - flink-logs:/opt/flink/logs
      - flink-data:/opt/flink/data
      - ./output:/opt/flink/output
    networks:
      - flink-network
    # 需求 4.5: 容器自动重启策略
    restart: unless-stopped
    # 健康检查配置（需求 8.8）
    healthcheck:
      test: ["CMD", "pgrep", "-f", "org.apache.flink.runtime.taskexecutor.TaskManagerRunner"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G


# 网络配置
networks:
  flink-network:
    driver: bridge
    name: flink-network

# 数据卷配置
volumes:
  flink-checkpoints:
    driver: local
    name: flink-checkpoints
  flink-savepoints:
    driver: local
    name: flink-savepoints
  flink-ha:
    driver: local
    name: flink-ha
  flink-logs:
    driver: local
    name: flink-logs
  flink-data:
    driver: local
    name: flink-data
  zookeeper-data:
    driver: local
    name: zookeeper-data
  zookeeper-logs:
    driver: local
    name: zookeeper-logs
